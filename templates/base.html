<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block description %}{{ config.description }}{% endblock %}">
    <meta name="author" content="{{ config.extra.author }}">

    <title>{% block title %}{{ config.title }}{% endblock %}</title>

    <!-- Canonical URL -->
    <link rel="canonical" href="{% block canonical %}{{ config.base_url | safe }}{% endblock %}">

    <!-- Open Graph -->
    <meta property="og:site_name" content="{{ config.title }}">
    {% block opengraph %}
    <meta property="og:title" content="{{ config.title }}">
    <meta property="og:description" content="{{ config.description }}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ config.base_url | safe }}">
    {% if config.extra.og_image %}
    <meta property="og:image" content="{{ config.base_url | safe }}{{ config.extra.og_image }}">
    {% endif %}
    {% endblock opengraph %}

    <!-- Twitter Card -->
    {% block twittercard %}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ config.title }}">
    <meta name="twitter:description" content="{{ config.description }}">
    {% if config.extra.og_image %}
    <meta name="twitter:image" content="{{ config.base_url | safe }}{{ config.extra.og_image }}">
    {% endif %}
    {% endblock twittercard %}

    <!-- Self-hosted fonts -->
    <style>
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 100 900;
            font-display: swap;
            src: url('/fonts/InterVariable.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Inter';
            font-style: italic;
            font-weight: 100 900;
            font-display: swap;
            src: url('/fonts/InterVariable-Italic.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Literata';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url('/fonts/Literata-Regular.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Literata';
            font-style: italic;
            font-weight: 400;
            font-display: swap;
            src: url('/fonts/Literata-Italic.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Literata';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: url('/fonts/Literata-Medium.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Literata';
            font-style: normal;
            font-weight: 600;
            font-display: swap;
            src: url('/fonts/Literata-SemiBold.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Literata';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url('/fonts/Literata-Bold.woff2') format('woff2');
        }
    </style>

    <!-- Stylesheet -->
    <link rel="stylesheet" href="{{ get_url(path='style.css') }}">

    <!-- KaTeX CSS -->
    {% if config.extra.katex %}
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/katex.min.css" integrity="sha384-Wsr4Nh3yrvMf2KCebJchRJoVo1gTU6kcP05uRSh5NV3sj9+a8IomuJoQzf3sMq4T" crossorigin="anonymous">
    {% endif %}

    <!-- Feeds -->
    {% if config.generate_feeds %}
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="{{ get_url(path='atom.xml') }}">
    {% endif %}

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>E</text></svg>">

    <!-- JSON-LD: WebSite + Person -->
    {% block jsonld %}
    <script type="application/ld+json">
    [{
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "{{ config.title }}",
        "url": "{{ config.base_url | safe }}",
        "description": "{{ config.description }}"
    },
    {
        "@context": "https://schema.org",
        "@type": "Person",
        "name": "{{ config.extra.author }}",
        "url": "{{ config.base_url | safe }}/about/"{% if config.extra.github %},
        "sameAs": ["{{ config.extra.github }}"{% if config.extra.linkedin %}, "{{ config.extra.linkedin }}"{% endif %}]{% endif %}
    }]
    </script>
    {% endblock jsonld %}
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <header class="site-header">
        <nav class="nav-container">
            <a href="{{ config.base_url }}" class="site-title">{{ config.title }}</a>
            <div class="nav-links">
                <a href="{{ get_url(path='blog') }}">Blog</a>
                <a href="{{ get_url(path='about') }}">About</a>
                <a href="{{ get_url(path='search') }}" class="search-link" aria-label="Search">
                    <svg class="feed-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </a>
                <a href="{{ get_url(path='atom.xml') }}" class="feed-link" aria-label="RSS Feed">
                    <svg class="feed-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="6.5" cy="17.5" r="2.5"/>
                        <path d="M4 4v3c7.18 0 13 5.82 13 13h3C20 10.03 13.97 4 4 4z"/>
                        <path d="M4 10v3c3.87 0 7 3.13 7 7h3c0-5.52-4.48-10-10-10z"/>
                    </svg>
                </a>
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
                    <span class="sun-icon">&#9728;</span>
                    <span class="moon-icon">&#9790;</span>
                </button>
            </div>
        </nav>
    </header>

    <main id="main-content" class="main-content">
        {% block content %}{% endblock %}
    </main>

    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-left">
                <p>&copy; {{ now() | date(format="%Y") }} {{ config.extra.author }}</p>
                <div class="footer-links">
                    <a href="{{ get_url(path='atom.xml') }}">RSS</a>
                    {% if config.extra.github %}
                    <a href="{{ config.extra.github }}" rel="noopener noreferrer" target="_blank">GitHub</a>
                    {% endif %}
                </div>
            </div>
            {% if config.extra.newsletter_endpoint %}
            <div class="footer-newsletter">
                <form class="newsletter-form newsletter-form--inline" action="{{ config.extra.newsletter_endpoint }}" method="POST">
                    <input type="email" name="email" placeholder="your@email.com" required aria-label="Email for newsletter">
                    <button type="submit">Subscribe</button>
                </form>
            </div>
            {% endif %}
        </div>
    </footer>

    <!-- Theme toggle script -->
    <script>
        (function() {
            const toggle = document.getElementById('theme-toggle');
            const html = document.documentElement;

            // Check for saved preference or system preference
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme) {
                html.setAttribute('data-theme', savedTheme);
            } else if (systemPrefersDark) {
                html.setAttribute('data-theme', 'dark');
            }

            toggle.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });
        })();
    </script>

    <!-- Newsletter form handler -->
    {% if config.extra.newsletter_endpoint %}
    <script>
        document.querySelectorAll('.newsletter-form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                var email = form.querySelector('input[name="email"]').value;
                var btn = form.querySelector('button[type="submit"]');
                var originalText = btn.textContent;
                btn.textContent = 'Sending...';
                btn.disabled = true;

                fetch(form.action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                }).then(function(res) {
                    if (res.ok) {
                        btn.textContent = 'Subscribed!';
                        form.querySelector('input[name="email"]').value = '';
                        setTimeout(function() { btn.textContent = originalText; btn.disabled = false; }, 3000);
                    } else {
                        throw new Error('Failed');
                    }
                }).catch(function() {
                    btn.textContent = 'Error - try again';
                    btn.disabled = false;
                    setTimeout(function() { btn.textContent = originalText; }, 3000);
                });
            });
        });
    </script>
    {% endif %}

    <!-- KaTeX auto-render -->
    {% if config.extra.katex %}
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/katex.min.js" integrity="sha384-+W9OcrYK2/bD7BmUAk+xeFAyKp0QjyRQUCxeU31dfyTt/FrPsUgaBTLLkVf33qWt" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });"></script>
    {% endif %}
</body>
</html>
